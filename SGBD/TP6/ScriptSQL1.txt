REM ********************************************************
REM CORRECTION Script TP 6
REM Auteur : FESSY Jérôme
REM ********************************************************

SET FEEDBACK OFF

PROMPT ** CREATION DES TABLES


drop table EmployeCadre cascade constraint purge;
drop table EmployeNonCadre cascade constraint purge;
drop table service cascade constraint purge;

-- -------------
-- TABLE SERVICE
-- -------------

CREATE TABLE service(
        idservice integer not null,
	libelleservice varchar(15) not null,
	idemployeresponsable integer,
        constraint pk_service primary key (idservice))
/
-- ------------------
-- TABLE EMPLOYECADRE
-- ------------------

CREATE TABLE employecadre(
        idemploye integer not null,
	nomemploye varchar(15) not null,
	dateembauche date not  null,
	grade varchar(5) not null,
	idservice integer not null,
        constraint pk_employecadre primary key (idemploye))
/

-- ---------------------
-- TABLE EMPLOYENONCADRE
-- ---------------------

CREATE TABLE employenoncadre(
        idemploye integer not null,
	nomemploye varchar(15) not null,
	dateembauche date not  null,
	nbheuresupannee integer not null,
	idservice integer not null,
	idEmployechef integer not null,
        constraint pk_employenoncadre primary key (idemploye))
/


-- -------------------
-- COMPLETER LE SCRIPT
-- -------------------

CREATE OR REPLACE TRIGGER T_PARTITION_EMPLOYECADRE
BEFORE INSERT ON employecadre
FOR EACH ROW
DECLARE
var INT;
BEGIN
	SELECT count(idemploye) into var FROM employenoncadre WHERE idemploye = :NEW.idemploye;
	IF var=1 THEN
		RAISE_APPLICATION_ERROR(-20001, 'Erreur : cet employe n''est pas dans le service');
	END IF;
END;
/
show err

CREATE OR REPLACE TRIGGER T_INCLUSION
BEFORE UPDATE ON SERVICE
FOR EACH ROW
DECLARE
var INT;
BEGIN
	SELECT count(*) into var 
	FROM employenoncadre 
	WHERE idservice = :NEW.idservice AND idemploye = :NEW.idemployeresponsable;
	IF var=0 THEN
		RAISE_APPLICATION_ERROR(-20001, 'Erreur : cet employe n''est pas dans le service');
	END IF;
END;
/
show err


SET FEEDBACK ON