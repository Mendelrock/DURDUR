SET LINESIZE 150
CLEAR SCREEN
SET FEEDBACK OFF

REM ------------------------------------
REM Cas 1 TRIGGERS : Triggers versus CIR
REM ------------------------------------

PROMPT CREATION TABLES
DROP TABLE CLIENT CASCADE CONSTRAINT PURGE
/
CREATE TABLE CLIENT 
(IdCli INTEGER CONSTRAINT PK_CLIENT PRIMARY KEY,
NomCli VARCHAR(30) NOT NULL,
VilleCli VARCHAR(30)
)
/

DROP TABLE COMMANDE CASCADE CONSTRAINT PURGE
/
CREATE TABLE COMMANDE 
(IdCom INTEGER CONSTRAINT PK_COMMANDE PRIMARY KEY,
LibelleCom VARCHAR(30),
DateCom DATE,
Ref_IdClient INTEGER CONSTRAINT FK_Commande REFERENCES CLIENT(IdCLi) ON DELETE CASCADE,
RefCom VARCHAR(10) UNIQUE, DateMAJ DATE, UserMAJ VARCHAR(30)
)
/

DROP TABLE PRODUIT CASCADE CONSTRAINT PURGE
/
CREATE TABLE PRODUIT
(IdProd INTEGER CONSTRAINT PK_PRODUIT PRIMARY KEY,
LibelleProd VARCHAR(30),
PrixProd NUMBER(10,2)
)
/

DROP TABLE LIGNECOMMANDE CASCADE CONSTRAINT PURGE
/
CREATE TABLE LIGNECOMMANDE 
(IdLC INTEGER,
DateLC DATE,
Ref_IdCom INTEGER CONSTRAINT FK_LC_Commande REFERENCES COMMANDE(IdCom) ON DELETE CASCADE,
REf_IdProd INTEGER CONSTRAINT FK_LC_produit REFERENCES PRODUIT(IdProd),
CONSTRAINT PK_LC PRIMARY KEY(IdLC, Ref_IdCom)
)
/

PROMPT CREATION DES SEQUENCES
DROP SEQUENCE seqcommande
/
CREATE SEQUENCE seqcommande
/

DROP SEQUENCE SEQPROD
/
CREATE SEQUENCE SEQPROD START WITH 200 INCREMENT BY 10
/

PROMPT INSERTION DONNEES

INSERT INTO CLIENT (Idcli, NomCli, VilleCli) VALUES (1, 'MCFORMS','PARIS');
INSERT INTO CLIENT (Idcli, NomCli, VilleCli) VALUES (2, 'CONSRAD','LONDRES');
INSERT INTO CLIENT (Idcli, NomCli, VilleCli) VALUES (3, 'FIMSTA','ROME');
INSERT INTO CLIENT (Idcli, NomCli, VilleCli) VALUES (4, 'EXODUS','BARCELONE');

INSERT INTO COMMANDE(Idcom, LibelleCom, DateCom, Ref_Idclient) VALUES (10, 'C_RUCHER_LG',SYSDATE,1);
INSERT INTO COMMANDE(Idcom, LibelleCom, DateCom, Ref_Idclient) VALUES (11, 'C_RUCHER_CA',SYSDATE,1);
INSERT INTO COMMANDE(Idcom, LibelleCom, DateCom, Ref_Idclient) VALUES (12, 'C_SECR_CA',SYSDATE,2);
INSERT INTO COMMANDE(Idcom, LibelleCom, DateCom, Ref_Idclient) VALUES (13, 'C_SECR_CA',SYSDATE,2);

INSERT INTO PRODUIT(Idprod, LibelleProd, PrixProd) VALUES (110, 'RUCHE DADAN 10 CADRES',250);
INSERT INTO PRODUIT(Idprod, LibelleProd, PrixProd) VALUES (120, 'ENFUMOIR D1',90);
INSERT INTO PRODUIT(Idprod, LibelleProd, PrixProd) VALUES (130, 'ENFUMOIR D2',110);
INSERT INTO PRODUIT(Idprod, LibelleProd, PrixProd) VALUES (140, 'CADRE DADAN',13);
INSERT INTO PRODUIT(Idprod, LibelleProd, PrixProd) VALUES (150, '100 CIRES GAUFREES',58);

INSERT INTO LIGNECOMMANDE (IdLC, DateLC, Ref_IdCom,Ref_Idprod) VALUES (1,SYSDATE,10,110);
INSERT INTO LIGNECOMMANDE (IdLC, DateLC, Ref_IdCom,Ref_Idprod) VALUES (2,SYSDATE,10,150);
INSERT INTO LIGNECOMMANDE (IdLC, DateLC, Ref_IdCom,Ref_Idprod) VALUES (1,SYSDATE,11,150);
INSERT INTO LIGNECOMMANDE (IdLC, DateLC, Ref_IdCom,Ref_Idprod) VALUES (1,SYSDATE,12,110);


COMMIT
/


REM ---------- TRIGGERS -------------

--CREATE OR REPLACE TRIGGER  T_Lock
--BEFORE INSERT OR UPDATE OR DELETE ON LigneCommande
--BEGIN
--	raise_application_error (-20001, 'Toute commande actuellement impossible');
--END;
--/

CREATE OR REPLACE TRIGGER T_CIR_PRODUIT
AFTER DELETE ON PRODUIT
FOR EACH ROW
BEGIN
DELETE LIGNECOMMANDE WHERE ref_idprod = :old.idprod;
END;
/


-- Liste des triggers de votre compte ------

PROMPT LISTE DES TRIGGERS

SELECT TRIGGER_NAME
FROM USER_TRIGGERS
/
PROMPT
PROMPT AFFICHAGE DES TABLES
PROMPT
PROMPT TABLE CLIENT
SELECT * FROM CLIENT
/
PROMPT
PROMPT -- TABLE PRODUIT
SELECT * FROM PRODUIT
/
PROMPT
PROMPT -- TABLE COMMANDE
SELECT * FROM COMMANDE
/
PROMPT
PROMPT -- LIGNE COMMANDE
SELECT * FROM LIGNECOMMANDE;
PROMPT
SET FEEDBACK ON